name: HaloITSM Plugin CI/CD (Simplified)

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  PLUGIN_NAME: haloitsm
  PLUGIN_DIR: plugins/haloitsm

jobs:
  # Basic validation and testing
  test:
    name: Test Plugin
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9']  # Start with just 3.9
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd ${{ env.PLUGIN_DIR }}
        pip install -r requirements.txt || echo "Requirements file not found or failed"
        pip install pytest pytest-cov || echo "Test dependencies install failed"

    - name: Install plugin runtime (attempt)
      run: |
        pip install insightconnect-plugin-runtime || echo "Plugin runtime install failed - continuing"
      continue-on-error: true

    - name: List installed packages (debug)
      run: pip list

    - name: Check Python path and imports
      run: |
        cd ${{ env.PLUGIN_DIR }}
        python -c "import sys; print('Python version:', sys.version); print('Python path:', sys.path)"
        python -c "import os; print('Current dir:', os.getcwd()); print('Dir contents:', os.listdir('.'))"
      continue-on-error: true

    - name: Run basic import test
      run: |
        cd ${{ env.PLUGIN_DIR }}
        python -c "
        import sys
        sys.path.append('.')
        try:
            from komand_haloitsm.actions.create_ticket.action import CreateTicket
            print('✓ CreateTicket import successful')
        except Exception as e:
            print('✗ CreateTicket import failed:', str(e))
        
        try:
            from komand_haloitsm.actions.get_ticket.action import GetTicket
            print('✓ GetTicket import successful')
        except Exception as e:
            print('✗ GetTicket import failed:', str(e))
        "
      continue-on-error: true

    - name: Run unit tests (if possible)
      run: |
        cd ${{ env.PLUGIN_DIR }}
        python -m pytest tests/ -v --tb=short || echo "Tests failed or pytest not available"
      continue-on-error: true

    - name: Check plugin spec (if insight-plugin available)
      run: |
        cd ${{ env.PLUGIN_DIR }}
        which insight-plugin && insight-plugin validate || echo "insight-plugin not available"
      continue-on-error: true

  # Code formatting check (simplified)
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install formatting tools
      run: |
        pip install black flake8
      continue-on-error: true

    - name: Check Black formatting
      run: |
        cd ${{ env.PLUGIN_DIR }}
        black --check --line-length 100 komand_${{ env.PLUGIN_NAME }}/ || echo "Black formatting check failed"
      continue-on-error: true

    - name: Run Flake8 linting
      run: |
        cd ${{ env.PLUGIN_DIR }}
        flake8 --max-line-length=100 --ignore=E203,W503 komand_${{ env.PLUGIN_NAME }}/ || echo "Flake8 linting failed"
      continue-on-error: true

  # Summary job
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test, format-check]
    if: always()
    steps:
    - name: Workflow Summary
      run: |
        echo "## HaloITSM Plugin Build Summary"
        echo "- Test Job: ${{ needs.test.result }}"
        echo "- Format Check: ${{ needs.format-check.result }}"
        echo ""
        echo "This simplified workflow helps identify core issues."
        echo "Once basic functionality works, we can expand the full workflow."